<!-- RTL Design Sherpa Documentation Header -->
<table>
<tr>
<td width="80">
  <a href="https://github.com/sean-galloway/RTLDesignSherpa">
    <img src="https://raw.githubusercontent.com/sean-galloway/RTLDesignSherpa/main/docs/logos/Logo_200px.png" alt="RTL Design Sherpa" width="70">
  </a>
</td>
<td>
  <strong>RTL Design Sherpa</strong> ¬∑ <em>Learning Hardware Design Through Practice</em><br>
  <sub>
    <a href="https://github.com/sean-galloway/RTLDesignSherpa">GitHub</a> ¬∑
    <a href="https://github.com/sean-galloway/RTLDesignSherpa/blob/main/docs/DOCUMENTATION_INDEX.md">Documentation Index</a> ¬∑
    <a href="https://github.com/sean-galloway/RTLDesignSherpa/blob/main/LICENSE">MIT License</a>
  </sub>
</td>
</tr>
</table>

---

<!-- End Header -->

# SMBus Controller - CDC Design Rationale

**Date:** 2025-11-16  
**Question:** Why doesn't SMBus need Clock Domain Crossing (CDC)?

---

## Answer: Architectural Design Decision (Not Speed)

SMBus uses **single clock domain architecture**, unlike HPET/PIT which have **dual clock domains**.

### üîç **Key Distinction**

**It's not primarily about SMBus being slow** - it's about the **architectural clock domain design**.

---

## Detailed Explanation

### SMBus Architecture (Single Clock Domain)

```
System Clock (pclk) - e.g., 100 MHz
        ‚îÇ
        ‚îú‚îÄ‚Üí APB Interface (runs at pclk)
        ‚îÇ
        ‚îú‚îÄ‚Üí SMBus Registers (runs at pclk)
        ‚îÇ
        ‚îî‚îÄ‚Üí SMBus Core & Physical Layer (runs at pclk)
                ‚îÇ
                ‚îî‚îÄ‚Üí Clock Divider (generates SCL timing from pclk)
                        ‚îÇ
                        ‚îî‚îÄ‚Üí SCL Output: 100 kHz or 400 kHz
```

**Key Point:** Everything runs synchronously on `pclk`. The SMBus SCL clock is **generated internally** using a programmable divider, but all logic is clocked by `pclk`.

**Module Signature:**
```systemverilog
module apb_smbus (
    input pclk,           // Single clock for everything
    input presetn,        // Single reset
    // ... APB interface ...
    // ... SMBus pins (SCL/SDA are outputs, not clocks) ...
);
```

### Compare: HPET Architecture (Dual Clock Domain)

```
APB Clock (pclk) - e.g., 50 MHz (low freq, power saving)
        ‚îÇ
        ‚îî‚îÄ‚Üí APB Interface
                ‚îÇ
                ‚îî‚îÄ‚Üí apb_slave_cdc (CDC HERE!)
                        ‚îÇ
                        ‚ñº
Timer Clock (hpet_clk) - e.g., 14.318 MHz (precise timing)
        ‚îÇ
        ‚îú‚îÄ‚Üí HPETRegisters
        ‚îÇ
        ‚îî‚îÄ‚Üí HPET Core & Counters
```

**Key Point:** Two separate, **asynchronous** clock domains that need CDC.

**Module Signature:**
```systemverilog
module apb_hpet (
    input pclk,           // APB clock domain
    input presetn,        // APB reset
    input hpet_clk,       // SEPARATE timer clock domain
    input hpet_resetn,    // HPET reset
    // ...
);
```

---

## Why The Difference?

### Modules That Need CDC

**HPET (High Precision Event Timer):**
- **Needs:** Precise, independent timing source (often 14.318 MHz crystal)
- **Reason:**  Accurate timestamps independent of system clock variations
- **Clock:** Separate `hpet_clk` input

**PIT (Programmable Interval Timer):**
- **Needs:** Independent timer operation that continues during APB clock changes
- **Reason:** System timers shouldn't glitch when CPU clock changes
- **Clock:** Separate `pit_clk` input

**RTC (Real-Time Clock):**
- **Option:** Can use 32.768 kHz crystal for battery-backed operation
- **Reason:** Keep time even when system is off/sleeping
- **Clock:** `rtc_clk` input (but also supports system clock mode)

### Modules That Don't Need CDC

**SMBus:**
- **Design:** I2C-compatible serial bus - SCL generated from system clock
- **Reason:** SMBus speed is **derived** from pclk, not independent
- **Speed:** 100-400 kHz generated by pclk divider (e.g., pclk/250 = 100kHz @ 100MHz)
- **Clock:** Single `pclk` - SCL is an output, not a clock input

**PIC (Programmable Interrupt Controller):**
- **Design:** Interrupt logic doesn't need independent timing
- **Reason:** Operates synchronously with system
- **Clock:** Single `pclk`

---

## Clock Domain Analysis

| Module | APB Clock | Core Clock | Why Different? | CDC Needed |
|--------|-----------|------------|----------------|------------|
| **HPET** | pclk (50MHz) | hpet_clk (14.318MHz) | Precise timestamps | ‚úÖ YES |
| **PIT** | pclk (variable) | pit_clk (1.193MHz) | Independent timing | ‚úÖ YES |
| **RTC** | pclk | rtc_clk (32.768kHz) **OR** pclk | Battery backup option | Optional |
| **SMBus** | pclk | pclk | Bus speed derived from pclk | ‚ùå NO |
| **PIC** | pclk | pclk | Synchronous interrupts | ‚ùå NO |

---

## SMBus Clock Generation Detail

### How SMBus SCL is Created

```systemverilog
// In smbus_core.sv - everything runs on system clk
always_ff @(posedge clk) begin  // <-- "clk" is pclk from APB
    if (r_clk_counter >= cfg_clk_div) begin
        r_clk_counter <= 16'h0;
        r_scl_gen <= ~r_scl_gen;  // Toggle SCL output
    end else begin
        r_clk_counter <= r_clk_counter + 1;
    end
end

// SCL Output (not a clock input!)
assign smb_scl_o = r_scl_gen;
assign smb_scl_t = r_scl_tristate;
```

**Example:** 100 MHz pclk ‚Üí 100 kHz SCL
- Clock divider = 249
- SCL frequency = 100 MHz / (4 √ó (249 + 1)) = 100 kHz
- All logic runs at 100 MHz (pclk)
- SCL is just a **generated output signal**, not a clock

---

## Speed Is NOT The Reason

### Common Misconception
‚ùå "SMBus doesn't need CDC because it's slow (100kHz)"

### Actual Reason
‚úÖ "SMBus doesn't need CDC because it uses **single clock domain design** - SCL is an output derived from pclk, not an independent clock input"

### Evidence
Even though SMBus is 1000x slower than pclk (100 kHz vs 100 MHz), we still run all SMBus logic at the fast pclk rate. The slow SCL speed is achieved by:
1. Running counters/FSMs at pclk (fast)
2. Generating SCL output by dividing pclk (slow output)
3. Everything synchronous to one clock

### Counter-Example
If speed alone determined CDC need, then:
- PIT (1.193 MHz) wouldn't need CDC from 50 MHz APB (only 42x difference)
- But HPET (14.318 MHz) DOES need CDC from 50 MHz APB (only 3.5x difference)

The ratio doesn't matter - it's whether you have **separate clock inputs**.

---

## Design Implications

### Advantages of Single Clock (SMBus choice)
‚úÖ Simpler design - no CDC complexity  
‚úÖ Lower latency - no synchronization delay  
‚úÖ Easier verification - single clock domain  
‚úÖ Smaller area - no CDC FIFOs needed  

### When This Works
‚úÖ Derived timing (bus protocols: I2C, SPI, UART)  
‚úÖ I/O where speed is controlled via dividers  
‚úÖ When core doesn't need independent operation  

### When CDC Is Needed
üîÑ Independent clock sources (crystals, PLLs)  
üîÑ Battery-backed operation  
üîÑ Precise timing independent of system  
üîÑ Multiple clock domains by requirement  

---

## Conclusion

**SMBus doesn't need CDC because:**

1. ‚úÖ **Architectural:** Designed as single clock domain (pclk only)
2. ‚úÖ **SCL Generation:** SCL derived from pclk via divider, not separate input
3. ‚úÖ **Synchronous Operation:** All registers/FSMs clocked by pclk
4. ‚úÖ **Design Choice:** SMBus spec doesn't require independent clock

**Not because:**
-‚ùå SMBus is "slow" (speed helps but isn't the reason)

**The slow SMBus speed (100-400 kHz) is achieved by:**
- Fast pclk (100 MHz) running state machines
- Clock divider creating slow SCL output
- Bit timing controlled by counters

This is a common pattern for serial bus controllers (I2C, SPI, UART) - they run fast internally and generate slow serial clocks as outputs.
