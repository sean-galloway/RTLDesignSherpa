# 4. Complete System Flow

## 4.1 Use Case: HIVE-C loads activations into Tile 7, Tile 7 computes, returns results

```
1. HIVE-C generates MM2S descriptor (load activations)
   - src_addr = 0x1000_0000 (DDR activation buffer)
   - dst_addr = 0 (unused for MM2S)
   - length = 0x1000 (4 KB)
   - dest_tile_id = 7
   - type = MM2S (Memory->Network)

2. HIVE-C injects descriptor:
   TDATA = descriptor (256 bits, 2 beats)
   TUSER = PKT_DESC (2'b01)
   TID = 0 (high priority)
   TDEST = 16 (RAPIDS)

3. DELTA routes PKT_DESC to RAPIDS:
   R3 (HIVE-C entry) -> R2 -> R1 -> R0 -> R4 -> R8 -> R12 -> RAPIDS

4. RAPIDS MM2S engine executes:
   - Reads 0x1000 bytes from DDR starting at 0x1000_0000
   - Formats AXIS packets:
     TDATA = activation_data
     TUSER = PKT_DATA (2'b00)
     TID = 0 (priority from descriptor)
     TDEST = 7 (destination tile)
   - Sends to DELTA

5. DELTA routes PKT_DATA to Tile 7:
   R12 -> R13 -> R14 -> R15 -> R11 -> R7

6. Tile 7 receives activations, performs computation

7. HIVE-C pre-programs S2MM descriptor for results:
   - src_addr = 0 (unused for S2MM)
   - dst_addr = 0x2000_0000 (DDR result buffer for tile 7)
   - length = 0x800 (2 KB results)
   - source_tile_id = 7 (CRITICAL - expect TID=7)
   - type = S2MM (Network->Memory)

8. HIVE-C injects S2MM descriptor:
   TDATA = descriptor
   TUSER = PKT_DESC
   TDEST = 16 (RAPIDS)

9. RAPIDS receives S2MM descriptor:
   - Reads source_tile_id = 7
   - Queues descriptor on S2MM Channel 7
   - Channel 7 now waiting for data with TID=7

10. Tile 7 completes computation, sends results:
    - Compute element sends to NI
    - NI enforces: TID <- 7 (MY_TILE_ID)
    - Packet created:
      TDATA = result_data
      TUSER = PKT_DATA (2'b00)
      TID = 7 (ENFORCED by NI - source tile ID)
      TDEST = 16 (RAPIDS)

11. DELTA routes PKT_DATA from Tile 7 to RAPIDS:
    R7 -> R11 -> R15 -> R14 -> R13 -> R12 -> RAPIDS
    (TID=7 preserved throughout)

12. RAPIDS S2MM receives packet:
    - Examines TID = 7
    - Routes to S2MM Channel 7
    - Channel 7 has queued descriptor ready
    - Writes 2 KB to DDR at 0x2000_0000
    - Generates completion interrupt

13. HIVE-C receives interrupt, proceeds to next operation
```

## 4.2 Key Points

- TID=7 set by Tile 7 NI (hardware enforced)
- TID preserved through entire DELTA routing path
- RAPIDS uses TID=7 to select S2MM Channel 7
- Descriptor on Channel 7 specifies DDR write address
- Complete isolation: each tile's results go to separate channel/memory region

## 4.3 Packet Type Routing Summary

| Packet Type | Generated By | Consumed By | Path |
|-------------|--------------|-------------|------|
| PKT_DATA | RAPIDS, Tiles | RAPIDS, Tiles | DELTA mesh (XY routing) |
| PKT_DESC | HIVE-C only | RAPIDS only | DELTA -> R12 -> RAPIDS |
| PKT_CONFIG | HIVE-C, SERV | Tile routers | DELTA mesh (broadcast or unicast) |
| PKT_STATUS | SERV only | HIVE-C only | DELTA -> R3 -> HIVE-C |

---

**Back to:** [Configuration Commands](03_configuration_commands.md) | **Next Chapter:** [Configuration Register Bank](../ch05_registers/01_config_registers.md)
