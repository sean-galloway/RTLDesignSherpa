# Bridge Batch Regeneration

## Quick Start

Regenerate all bridges from batch file in one command:

```bash
cd projects/components/bridge/bin
python3 bridge_generator.py --bulk bridge_batch.csv
```

## Batch File Format

The `bridge_batch.csv` file controls which bridges are generated:

```csv
name,ports,connectivity,output_dir,output_tb,output_test,expose_arbiter_signals
bridge_1x2_rd,test_configs/bridge_1x2_rd_matched.toml,test_configs/bridge_1x2_rd_matched_connectivity.csv,../rtl/generated,../dv/tbclasses,../dv/tests,false
bridge_1x2_wr,test_configs/bridge_1x2_wr_matched.toml,test_configs/bridge_1x2_wr_matched_connectivity.csv,../rtl/generated,../dv/tbclasses,../dv/tests,false
#bridge_2x2_rw,test_configs/bridge_2x2_rw.toml,test_configs/bridge_2x2_rw_connectivity.csv,../rtl/generated,../dv/tbclasses,../dv/tests,false
```

**Note:** The generator now uses **TOML** as the primary configuration format (preferred over CSV or YAML for better structure and interface configuration support).

## CSV Columns

| Column | Description | Example |
|--------|-------------|---------|
| `name` | Bridge name (used for module name) | `bridge_1x2_rd` |
| `ports` | Path to port configuration (TOML/YAML/CSV) | `test_configs/bridge_1x2_rd_matched.toml` |
| `connectivity` | Path to CSV connectivity matrix | `test_configs/bridge_1x2_rd_matched_connectivity.csv` |
| `output_dir` | RTL output directory | `../rtl/generated` |
| `output_tb` | Testbench class output directory | `../dv/tbclasses` |
| `output_test` | Test file output directory | `../dv/tests` |
| `expose_arbiter_signals` | Expose arbiter debug signals | `false` |

**Supported Port Configuration Formats:**
- **TOML** (`.toml`) - **Preferred** - Best structure, interface config support, inline defaults
- **YAML** (`.yaml`, `.yml`) - Legacy support, still functional
- **CSV** (`.csv`) - Legacy support, requires separate connectivity CSV

## Comment Lines

Lines starting with `#` are skipped:

```csv
# This entire line is ignored
#bridge_2x2_rw,test_configs/bridge_2x2_rw.toml,...  # Commented-out bridge
```

**To enable a disabled bridge:** Remove the `#` from the start of the line.

## Why Batch File?

The batch file provides centralized control over bridge regeneration:

1. **Single Source of Truth** - One file controls all generated bridges
2. **Selective Generation** - Comment out bridges you don't need
3. **Documentation** - CSV shows all bridge configurations at a glance
4. **Version Control** - Track which bridges are active in git
5. **Automation** - Easy to regenerate all bridges after generator changes

## Common Workflows

### Regenerate All Active Bridges

```bash
python3 bridge_generator.py --bulk bridge_batch.csv
```

### Add a New Bridge

1. Create TOML config: `test_configs/bridge_new.toml`
2. Create connectivity CSV: `test_configs/bridge_new_connectivity.csv`
3. Add line to `bridge_batch.csv`:
   ```csv
   bridge_new,test_configs/bridge_new.toml,test_configs/bridge_new_connectivity.csv,../rtl/generated,../dv/tbclasses,../dv/tests,false
   ```
4. Regenerate:
   ```bash
   python3 bridge_generator.py --bulk bridge_batch.csv
   ```

### Temporarily Disable a Bridge

Add `#` to the start of the line:

```csv
#bridge_2x2_rw,test_configs/bridge_2x2_rw.toml,test_configs/bridge_2x2_rw_connectivity.csv,../rtl/generated,../dv/tbclasses,../dv/tests,false
```

### Clean and Regenerate

Following CRITICAL RULE #0 (see `CLAUDE.md`), always delete ALL generated files when regenerating:

```bash
# Step 1: Delete all generated bridges
cd projects/components/bridge/rtl/generated
rm -rf bridge_*

# Step 2: Regenerate from batch file
cd ../../bin
python3 bridge_generator.py --bulk bridge_batch.csv

# Step 3: Verify compilation
cd ../rtl
for f in filelists/bridge_*.f; do
    bridge_name=$(basename "$f" .f)
    echo -n "Testing $bridge_name ... "
    if verilator --lint-only -f "$f" --top-module "$bridge_name" 2>&1 | grep -q "Error"; then
        echo "FAILED"
    else
        echo "PASS"
    fi
done
```

## Current Active Bridges

From `bridge_batch.csv`:

- `bridge_1x2_rd` - 1 master, 2 slaves, read-only, matched data widths (32b)
- `bridge_1x2_wr` - 1 master, 2 slaves, write-only, matched data widths (32b)
- `bridge_1x3_rd` - 1 master, 3 slaves, read-only, mixed data widths (32/64/128b)
- `bridge_1x3_wr` - 1 master, 3 slaves, write-only, mixed data widths (32/64/128b)
- `bridge_1x4_rd` - 1 master, 4 slaves, read-only, with APB protocol slave
- `bridge_1x5_rd` - 1 master, 5 slaves, read-only, with APB + AXI4-Lite slaves

## Disabled Bridges

Commented out in `bridge_batch.csv` (not generated by default):

- `bridge_2x2_rw` - 2 masters, 2 slaves, full read/write
- `bridge_4x4_rw` - 4 masters, 4 slaves, full read/write
- `bridge_5x3_channels` - 5 masters, 3 slaves, mixed channels
- `bridge_example` - Example bridge configuration

## Integration with Makefiles

To add batch regeneration to Makefile:

```makefile
.PHONY: regen-bridges
regen-bridges:
    cd bin && python3 bridge_generator.py --bulk bridge_batch.csv

.PHONY: clean-bridges
clean-bridges:
    rm -rf rtl/generated/bridge_*

.PHONY: clean-regen-bridges
clean-regen-bridges: clean-bridges regen-bridges
```

## See Also

- `CLAUDE.md` - Critical Rule #0 for regeneration requirements
- `test_configs/README.md` - TOML configuration file format
- `bridge_generator.py --help` - Generator command-line options
