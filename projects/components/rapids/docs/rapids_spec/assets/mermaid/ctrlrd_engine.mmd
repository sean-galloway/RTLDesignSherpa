graph TB
    subgraph "Control Read Engine"
        subgraph "Input Interface"
            SCHED_IN[Scheduler Interface<br/>ctrlrd_valid<br/>ctrlrd_addr<br/>ctrlrd_data<br/>ctrlrd_mask] --> FSM
            CFG_IN[Configuration<br/>cfg_max_retry<br/>cfg_timeout] --> FSM
        end

        subgraph "Control Read FSM (5 States)"
            FSM[Main FSM] --> |CTRLRD_IDLE| IDLE[Wait for Request]
            FSM --> |CTRLRD_ISSUE_AR| ISSUE_AR[Issue AR Channel]
            FSM --> |CTRLRD_WAIT_R| WAIT_R[Wait for R Response]
            FSM --> |CTRLRD_COMPARE| COMPARE[Compare Data]
            FSM --> |CTRLRD_RETRY| RETRY[Retry or Error]
        end

        subgraph "AXI Read Path"
            FSM --> |ar_valid/addr| AR_CH[AR Channel<br/>Single Beat Read]
            AR_CH --> |ar_ready| FSM
            R_CH[R Channel<br/>r_valid/data/resp] --> FSM
            FSM --> |r_ready| R_CH
        end

        subgraph "Read-and-Compare Logic"
            FSM --> |r_data| MASK_APPLY[Apply Mask<br/>r_data & mask]
            MASK_APPLY --> CMP[Compare<br/>masked_data == expected]
            CMP --> |match| MATCH_OUT[Match Success]
            CMP --> |mismatch| RETRY_CHK[Check Retry Count]
        end

        subgraph "Retry Management"
            RETRY_CHK --> |retries < max| RETRY_CNT[Increment Retry<br/>Back to ISSUE_AR]
            RETRY_CHK --> |retries >= max| ERROR_OUT[Max Retries Error]
            RETRY_CNT --> FSM
        end

        subgraph "Timeout Handling"
            FSM --> |start_timer| TIMEOUT[Timeout Counter]
            TIMEOUT --> |timeout_expired| ERROR_OUT
        end

        subgraph "Output Interface"
            MATCH_OUT --> |ctrlrd_ready| SCHED_OUT[To Scheduler]
            ERROR_OUT --> |ctrlrd_error| SCHED_OUT
            FSM --> |ctrlrd_result| RESULT_OUT[Actual Read Data]
            FSM --> |mon_valid/packet| MON_OUT[MonBus Events]
        end
    end

    AR_CH --> MEM[System Memory]
    MEM --> R_CH

    style FSM fill:#f9f,stroke:#333,stroke-width:3px
    style CMP fill:#bfb,stroke:#333,stroke-width:2px
    style RETRY_CHK fill:#ffb,stroke:#333,stroke-width:2px
    style TIMEOUT fill:#fbb,stroke:#333,stroke-width:2px
