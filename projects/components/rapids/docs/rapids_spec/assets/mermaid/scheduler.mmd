graph TB
    subgraph "Scheduler Block"
        subgraph "Input Interfaces"
            DESC_IN[Descriptor Input<br/>descriptor_valid/ready] --> MAIN_FSM
            CREDIT_IN[Credit Input<br/>credit_increment] --> CREDIT_MGR
            CFG_IN[Configuration<br/>cfg_idle_mode<br/>cfg_channel_wait<br/>cfg_channel_enable<br/>cfg_use_credit<br/>cfg_initial_credit] --> MAIN_FSM
            CFG_IN --> CREDIT_MGR
            EOS_IN[EOS Completion<br/>eos_completion_valid] --> MAIN_FSM
        end

        subgraph "Main Scheduler FSM"
            MAIN_FSM[Main FSM<br/>6 States] --> |SCHED_IDLE| IDLE_STATE[Wait for Descriptor]
            MAIN_FSM --> |SCHED_WAIT_FOR_CONTROL| WAIT_STATE[Check Channel Control]
            MAIN_FSM --> |SCHED_ISSUE_CTRLRD| CTRLRD_STATE[Issue Control Read]
            MAIN_FSM --> |SCHED_DESCRIPTOR_ACTIVE| ACTIVE_STATE[Data Transfer Active]
            MAIN_FSM --> |SCHED_ISSUE_CTRLWR0/1| CTRLWR_STATE[Issue Control Writes]
            MAIN_FSM --> |SCHED_ERROR| ERROR_STATE[Error Recovery]
        end

        subgraph "Parallel Alignment FSM"
            ALIGN_FSM[Alignment FSM<br/>7 States] --> |ALIGN_IDLE| A_IDLE[Wait for Descriptor]
            ALIGN_FSM --> |ANALYZE_ADDRESS| A_ANALYZE[Extract Offset]
            ALIGN_FSM --> |CALC_FIRST| A_FIRST[First Transfer Params]
            ALIGN_FSM --> |CALC_STREAMING| A_STREAM[Streaming Params]
            ALIGN_FSM --> |CALC_FINAL| A_FINAL[Final Transfer Params]
            ALIGN_FSM --> |ALIGNMENT_COMPLETE| A_DONE[Info Valid]
        end

        subgraph "Credit Management"
            CREDIT_MGR[Credit Manager<br/>Exponential Encoding] --> |credit_available| MAIN_FSM
            CREDIT_MGR --> |credit_counter| STATUS_OUT
        end

        ACTIVE_STATE --> |triggers| ALIGN_FSM

        subgraph "Output Interfaces"
            MAIN_FSM --> |ctrlrd_valid/addr/data/mask| CTRLRD_OUT[CtrlRd Output]
            MAIN_FSM --> |ctrlwr_valid/addr/data| CTRLWR_OUT[CtrlWr Output]
            MAIN_FSM --> |data_valid/addr/len/eos| DATA_OUT[Data Output]
            ALIGN_FSM --> |alignment_info_t| ALIGN_OUT[Alignment Bus]
            MAIN_FSM --> |mon_valid/packet| MON_OUT[MonBus Output]
            MAIN_FSM --> |scheduler_idle/error| STATUS_OUT[Status Output]
        end
    end

    style MAIN_FSM fill:#f9f,stroke:#333,stroke-width:3px
    style ALIGN_FSM fill:#bbf,stroke:#333,stroke-width:2px
    style CREDIT_MGR fill:#bfb,stroke:#333,stroke-width:2px
