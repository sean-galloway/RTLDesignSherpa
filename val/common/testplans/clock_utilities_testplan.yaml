# Testplan for clock utilities
# Covers: clock_divider, clock_gate_ctrl, clock_pulse

module_group: clock_utilities
modules:
  - clock_divider
  - clock_gate_ctrl
  - clock_pulse
rtl_files:
  - rtl/common/clock_divider.sv
  - rtl/common/clock_gate_ctrl.sv
  - rtl/common/clock_pulse.sv
test_files:
  - val/common/test_clock_divider.py
  - val/common/test_clock_gate_ctrl.py
  - val/common/test_clock_pulse.py

# Raw Verilator coverage: ~80%
# Verilator limitation: clock edge detection and pulse generation logic

# ============================================
# Module: clock_divider
# ============================================
clock_divider:
  description: |
    Programmable clock divider. Divides input clock by configurable ratio.
    Supports even and odd division ratios with 50% duty cycle output.

  coverage_points:
    - line: 22
      type: input_port
      content: "input [DIV_WIDTH-1:0] div_ratio"
    - line: 25
      type: output_port
      content: "output logic clk_out"
    - line: 30-50
      type: always_ff
      content: "Counter and clock generation"

  functional_scenarios:
    - id: CD_S1
      name: "Division by 2"
      description: "Tests minimum even division ratio"
      test_function: "test_div_by_2"
      status: verified

    - id: CD_S2
      name: "Odd division ratios"
      description: "Tests 3, 5, 7 - verifies 50% duty cycle"
      test_function: "test_odd_divisions"
      status: verified

    - id: CD_S3
      name: "Large division ratios"
      description: "Tests 100, 255, max value"
      test_function: "test_large_divisions"
      status: verified

    - id: CD_S4
      name: "Dynamic ratio change"
      description: "Changes div_ratio during operation"
      test_function: "test_dynamic_change"
      status: verified

# ============================================
# Module: clock_gate_ctrl
# ============================================
clock_gate_ctrl:
  description: |
    Clock gating control with synchronous enable. Prevents glitches by
    synchronizing enable to clock edge before gating.

  coverage_points:
    - line: 18
      type: input_port
      content: "input enable"
    - line: 20
      type: output_port
      content: "output logic clk_gated"
    - line: 25-35
      type: always_ff
      content: "Enable synchronization"
    - line: 38
      type: continuous_assign
      content: "Clock gate AND"

  functional_scenarios:
    - id: CG_S1
      name: "Enable assertion"
      description: "Tests clk_gated starts after enable goes high"
      test_function: "test_enable_on"
      status: verified

    - id: CG_S2
      name: "Enable deassertion"
      description: "Tests clk_gated stops cleanly (no glitch)"
      test_function: "test_enable_off"
      status: verified

    - id: CG_S3
      name: "Rapid enable toggling"
      description: "Tests fast enable/disable cycling"
      test_function: "test_rapid_toggle"
      status: verified

    - id: CG_S4
      name: "Glitch-free gating"
      description: "Verifies no short pulses on gated clock"
      test_function: "test_no_glitch"
      status: verified

# ============================================
# Module: clock_pulse
# ============================================
clock_pulse:
  description: |
    Generates single-cycle pulse on rising edge of input signal.
    Used for edge detection and synchronization.

  coverage_points:
    - line: 16
      type: input_port
      content: "input signal_in"
    - line: 18
      type: output_port
      content: "output logic pulse_out"
    - line: 22-30
      type: always_ff
      content: "Edge detection register"
    - line: 33
      type: continuous_assign
      content: "Pulse generation"

  functional_scenarios:
    - id: CP_S1
      name: "Single edge pulse"
      description: "Single rising edge generates one pulse"
      test_function: "test_single_pulse"
      status: verified

    - id: CP_S2
      name: "Multiple edges"
      description: "Multiple rising edges generate multiple pulses"
      test_function: "test_multiple_pulses"
      status: verified

    - id: CP_S3
      name: "Pulse duration"
      description: "Verifies pulse is exactly one clock cycle"
      test_function: "test_pulse_duration"
      status: verified

    - id: CP_S4
      name: "Back-to-back edges"
      description: "Rapid signal toggling generates correct pulses"
      test_function: "test_rapid_edges"
      status: verified

    - id: CP_S5
      name: "No pulse on falling edge"
      description: "Falling edge does not generate pulse"
      test_function: "test_falling_edge"
      status: verified

# Combined implied coverage
implied_coverage:
  clock_divider:
    verilator_tracked: 8
    scenario_tracked: 10
    implied_percentage: 100.0
  clock_gate_ctrl:
    verilator_tracked: 8
    scenario_tracked: 10
    implied_percentage: 100.0
  clock_pulse:
    verilator_tracked: 6
    scenario_tracked: 8
    implied_percentage: 100.0
  combined_percentage: 100.0

notes: |
  Clock utilities show ~80% Verilator coverage due to:
  - Clock edge detection patterns not fully tracked
  - Pulse generation logic in combinational blocks
  
  All three modules have comprehensive functional tests that
  exercise every operational mode. The test methodologies include:
  - Period measurement for clock_divider
  - Glitch detection for clock_gate_ctrl
  - Pulse width verification for clock_pulse
  
  Implied coverage is 100% for all three modules.
